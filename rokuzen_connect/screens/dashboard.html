<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - ROKUZEN</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #A3C441;
      --primary-hover: #8FB23A;
    }
    
    #unitsGrid {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 1.5rem;
    }
    
    .unit-card-wrapper {
      display: flex;
      justify-content: center;
      width: 100%;
    }
    
    .unit-card { 
      transition: box-shadow 0.3s ease, transform 0.3s ease; 
      border: none; 
      height: 100%;
      width: 100%;
      max-width: 800px;
    }
    
    .unit-card:hover { 
      box-shadow: 0 8px 32px rgba(0,0,0,0.08) !important; 
      transform: translateY(-2px); 
    }
    
    .status-dot { 
      width: 16px; height: 16px; border-radius: 50%; 
      flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
      display: inline-block; vertical-align: middle; 
    }
    .status-dot.green { background: var(--primary-color); }
    .status-dot.red { background: #e74c3c; }
    .status-dot.yellow { background: #f1c40f; }
    .status-dot.gray { background: #dee2e6; }
    
    .post-card { 
      min-height: 120px; 
      transition: box-shadow 0.3s ease, transform 0.3s ease; 
      border: none; 
    }
    
    .post-card:hover { 
      box-shadow: 0 8px 32px rgba(0,0,0,0.08) !important; 
      transform: translateY(-4px); 
    }
    
    .quick-access { 
      background: white; 
      border-radius: 1rem; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
    }
    
    .btn-success { 
      background: var(--primary-color); 
      border: none; 
    }
    
    .btn-success:hover { 
      background: var(--primary-hover); 
      transform: translateY(-1px); 
    }
    
    .btn-outline-success { 
      color: var(--primary-color); 
      border-color: var(--primary-color); 
    }
    
    .btn-outline-success:hover { 
      background: var(--primary-color); 
      border-color: var(--primary-color); 
      color: white; 
      transform: translateY(-1px); 
    }

    [data-posts] { 
      min-height: 180px;
      display: flex; 
      flex-wrap: wrap; 
      gap: 1rem;
    }
    
    [data-posts] .post-card { 
      flex: 1 1 calc(50% - 0.5rem);
      min-width: 0;
    }
    
    @media (min-width: 992px) {
      [data-posts] .post-card { 
        flex: 1 1 calc(33.333% - 0.666rem); 
      }
    }

    .post-type:empty, .assigned:empty, .timer:empty { display: none; }
    .post-name:empty::before { content: "Posto Vazio"; color: #6c757d; font-style: italic; }
    .post-type { color: var(--primary-color); }
  </style>
</head>
<body class="bg-light">
  <header class="bg-white shadow-sm py-3">
    <div class="container d-flex align-items-center justify-content-between">
      <a href="../index.html" class="btn btn-outline-success btn-sm">Voltar</a>
      <h1 class="h4 mb-0 fw-bold text-center flex-grow-1">ROKUZEN - Unidades</h1>
      <div id="headerActions" class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-success d-none" id="addUnitBtn">Adicionar Unidade</button>
      </div>
    </div>
  </header>

  <main class="container py-4" id="unitsArea">


    <!-- Units Grid com centralização -->
    <div class="row g-4" id="unitsGrid">
      <!-- Os cards serão inseridos aqui pelo JavaScript -->
    </div>
  </main>

  <template id="unitCardTemplate">
    <div class="col-12 unit-card-wrapper">
      <article class="unit-card card border-0 shadow-sm">
        <div class="card-body">
          <h3 class="unit-name h5 fw-bold mb-3 px-4 pt-4"></h3>
          <div class="posts-grid mb-4 px-4 pb-4" data-posts></div>
          <div class="unit-footer d-flex align-items-center justify-content-between px-4 pb-4">
            <small class="next-appointments text-muted"></small>
            <!-- CORREÇÃO: Link correto para abrir unidade -->
            <a class="btn btn-sm btn-success view-btn shadow-sm">Abrir Unidade</a>
          </div>
        </div>
      </article>
    </div>
  </template>

  <template id="postInUnitTemplate">
    <div class="post-card card border-0 shadow-sm h-100">
      <div class="card-body p-3">
        <div class="post-header">
          <span class="post-type small text-success fw-semibold"></span>
          <strong class="post-name d-block h6 mb-2 fw-bold"></strong>
        </div>
        <div class="post-body d-flex align-items-center gap-3">
          <div class="status-dot"></div>
          <div class="post-info flex-grow-1">
            <div class="assigned fw-medium small"></div>
            <div class="timer text-muted x-small"></div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Código JavaScript corrigido acima
    document.addEventListener('DOMContentLoaded', () => {
      setupHeader();
      renderUnits();
      setupStorageListener();
    });

    function setupHeader() {
      const headerActions = document.getElementById('headerActions');
      const user = JSON.parse(sessionStorage.getItem('rok_user') || 'null');

      if (user) {
        headerActions.innerHTML = `<span class="badge bg-success">${user.role.toUpperCase()}: ${user.name}</span> <a class="btn btn-outline-success btn-sm" href="#" id="logout">Sair</a>`;

        const logoutButton = document.getElementById('logout');
        logoutButton.addEventListener('click', (e) => {
          e.preventDefault();
          sessionStorage.removeItem('rok_user');
          location.reload();
        });
      }
    }

    function renderUnits() {
      const root = document.getElementById('unitsGrid');
      const template = document.getElementById('unitCardTemplate');

      if (!root || !template) return;

      const data = JSON.parse(localStorage.getItem('rok_data') || '{}');
      const units = data.units || [];

      root.innerHTML = '';

      units.forEach(unit => {
        const node = template.content.cloneNode(true);
        const postsGrid = node.querySelector('[data-posts]');

        node.querySelector('.unit-name').textContent = unit.name;

        const postsToShow = unit.posts.slice(0, 3);
        postsToShow.forEach(post => {
          const miniPostElement = createMiniPostElement(post);
          postsGrid.appendChild(miniPostElement);
        });

        const nextAppointment = (unit.appointments && unit.appointments[0]);
        node.querySelector('.next-appointments').textContent = nextAppointment
          ? `Próx: ${nextAppointment.time} - ${nextAppointment.client}`
          : 'Sem agendamentos';

        // CORREÇÃO: Configurar o botão para abrir a unidade (mesma pasta)
        const viewButton = node.querySelector('.view-btn');
        viewButton.href = `unidade.html?unit=${unit.id}`;
        
        // Event listener para garantir a navegação
        viewButton.addEventListener('click', (e) => {
          e.preventDefault();
          window.location.href = `unidade.html?unit=${unit.id}`;
        });

        root.appendChild(node);
      });
    }

    function setupStorageListener() {
      window.addEventListener('storage', (e) => {
        if (e.key === 'rok_data') {
          renderUnits();
        }
      });
    }

    function createMiniPostElement(post) {
      const statusColorMap = {
        'free': 'green',
        'occupied': 'red', 
        'interval': 'yellow',
      };
      const color = statusColorMap[post.status] || 'gray';

      const template = document.getElementById('postInUnitTemplate');
      const node = template.content.cloneNode(true);

      node.querySelector('.post-type').textContent = post.type || 'Posto';
      node.querySelector('.post-name').textContent = post.name;
      node.querySelector('.status-dot').className = `status-dot ${color}`;
      
      const assigned = node.querySelector('.assigned');
      const timer = node.querySelector('.timer');
      
      if (post.assigned && post.assigned !== 'undefined') {
        assigned.textContent = post.assigned;
      } else {
        assigned.style.display = 'none';
      }
      
      if (post.timer && post.timer !== 'undefined') {
        timer.textContent = post.timer;
      } else {
        timer.style.display = 'none';
      }

      return node;
    }
  </script>
</body>
</html>