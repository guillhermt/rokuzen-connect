<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controle Interno - ROKUZEN</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --rokuzen: #a3c441;
        --rokuzen-dark: #8fb23a;
        --danger: #e74c3c;
        --warning: #f39c12;
        --gray: #95a5a6;
      }
      body {
        background: #f8f9fa;
        font-family: "Segoe UI", sans-serif;
      }
      .posto-card {
        border: none;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }
      .posto-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }
      .status-livre {
        background: linear-gradient(135deg, #d5efbb, var(--rokuzen));
      }
      .status-ocupado {
        background: linear-gradient(135deg, #fadbd8, var(--danger));
      }
      .status-manutencao {
        background: linear-gradient(135deg, #fcf3cf, var(--warning));
      }
      .status-intervalo {
        background: linear-gradient(135deg, #ebdef0, #9b59b6);
      }
      .posto-header {
        padding: 1.5rem;
        color: white;
      }
      .posto-body {
        background: white;
        padding: 1.5rem;
      }
      .timer {
        font-size: 1.8rem;
        font-weight: bold;
        color: #2c3e50;
      }
      .btn-action {
        border-radius: 50px;
        padding: 0.6rem 1.5rem;
        font-weight: 600;
      }
      .refresh-info {
        font-size: 0.85rem;
        color: #7f8c8d;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="mb-1 fw-bold text-dark" id="nomeUnidade">Carregando...</h2>
          <small class="text-muted">Controle de Postos em Tempo Real</small>
        </div>
        <div class="text-end">
          <span class="badge bg-success fs-6" id="userBadge"
            >Carregando...</span
          >
          <button class="btn btn-outline-danger btn-sm ms-3" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i> Sair
          </button>
        </div>
      </div>

      <!-- Última atualização -->
      <div
        class="alert alert-light border refresh-info mb-4"
        id="ultimaAtualizacao"
      >
        Atualizando em <span id="contador">10</span>s...
      </div>

      <!-- Grid de Postos -->
      <div class="row g-4" id="postosGrid">
        <div class="col-12 text-center">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Carregando postos...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Template do Posto -->
    <template id="postoTemplate">
      <div class="col-md-6 col-lg-4 col-xxl-3">
        <div class="posto-card h-100">
          <div class="posto-header status-livre text-white">
            <h5 class="mb-0 fw-bold d-flex justify-content-between">
              <span class="nome-posto">Maca 1</span>
              <span class="badge bg-white text-dark tipo-posto">Massagem</span>
            </h5>
          </div>
          <div class="posto-body">
            <div class="text-center mb-3">
              <div class="timer">00:00</div>
              <small class="text-muted status-texto">LIVRE</small>
            </div>
            <div class="info-sessao mb-3" style="display: none">
              <hr />
              <p class="mb-1">
                <strong>Terapeuta:</strong> <span class="terapeuta">-</span>
              </p>
              <p class="mb-1">
                <strong>Cliente:</strong> <span class="cliente">-</span>
              </p>
            </div>
            <div class="d-grid gap-2">
              <button class="btn btn-success btn-action btn-iniciar">
                <i class="bi bi-play-fill"></i> Iniciar Sessão
              </button>
              <button class="btn btn-danger btn-action btn-finalizar" disabled>
                <i class="bi bi-stop-fill"></i> Finalizar
              </button>
              <button class="btn btn-warning btn-action btn-manutencao btn-sm">
                <i class="bi bi-tools"></i> Manutenção
              </button>
            </div>
          </div>
        </div>
      </div>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE = "http://localhost:3000";
      const token = localStorage.getItem("token");
      const user = JSON.parse(localStorage.getItem("rok_user") || "null");
      const urlParams = new URLSearchParams(window.location.search);
      const unidadeId = urlParams.get("id");

      // Verifica login
      if (!token || !user) {
        alert("Acesso restrito. Faça login.");
        window.location.href = "login.html";
      }

      let contador = 10;
      let intervalos = {};

      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("userBadge").textContent =
          user.tipo_colaborador === 1
            ? "ADMIN"
            : user.tipo_colaborador === 2
            ? "RECEPÇÃO"
            : "TERAPEUTA";

        if (!unidadeId) {
          alert("Unidade não informada");
          window.location.href = "dashboard.html";
          return;
        }

        carregarUnidadeNome();
        carregarPostos();
        setInterval(() => {
          if (contador <= 0) {
            carregarPostos();
            contador = 10;
          }
          document.getElementById("contador").textContent = contador;
          contador--;
        }, 1000);
      });

      async function carregarUnidadeNome() {
        try {
          const res = await fetch(`${API_BASE}/unidades/${unidadeId}`);
          const data = await res.json();
          document.getElementById("nomeUnidade").textContent =
            data.nome_unidade;
        } catch (err) {}
      }

      async function carregarPostos() {
        const grid = document.getElementById("postosGrid");
        try {
          const res = await fetch(`${API_BASE}/postos?unidade_id=${unidadeId}`);
          if (!res.ok) throw new Error("Erro");
          const postos = await res.json();

          if (postos.length === 0) {
            grid.innerHTML = `<div class="col-12 text-center py-5"><h5 class="text-muted">Nenhum posto cadastrado nesta unidade</h5></div>`;
            return;
          }

          grid.innerHTML = "";
          postos.forEach((posto) => criarCardPosto(posto, grid));
          document.getElementById(
            "ultimaAtualizacao"
          ).innerHTML = `Atualizado agora às ${new Date().toLocaleTimeString()}`;
        } catch (err) {
          grid.innerHTML = `<div class="col-12 text-danger text-center">Erro ao carregar postos</div>`;
        }
      }

      function criarCardPosto(posto, container) {
        const template = document
          .getElementById("postoTemplate")
          .content.cloneNode(true);
        const card = template.querySelector(".posto-card");
        const header = card.querySelector(".posto-header");
        const nome = card.querySelector(".nome-posto");
        const tipo = card.querySelector(".tipo-posto");
        const timer = card.querySelector(".timer");
        const statusTexto = card.querySelector(".status-texto");
        const infoSessao = card.querySelector(".info-sessao");
        const terapeutaSpan = card.querySelector(".terapeuta");
        const clienteSpan = card.querySelector(".cliente");
        const btnIniciar = card.querySelector(".btn-iniciar");
        const btnFinalizar = card.querySelector(".btn-finalizar");
        const btnManutencao = card.querySelector(".btn-manutencao");

        nome.textContent = posto.nome_posto;
        tipo.textContent = posto.tipo_posto.toUpperCase();

        // Status
        let status = posto.status || "livre";
        if (posto.em_manutencao === "S") status = "manutencao";

        header.className = `posto-header ${
          status === "livre"
            ? "status-livre"
            : status === "ocupado"
            ? "status-ocupado"
            : status === "manutencao"
            ? "status-manutencao"
            : "status-intervalo"
        } text-white`;

        const textos = {
          livre: "LIVRE",
          ocupado: "OCUPADO",
          manutencao: "EM MANUTENÇÃO",
          intervalo: "EM INTERVALO",
        };
        statusTexto.textContent = textos[status] || "LIVRE";
        statusTexto.className = `text-uppercase fw-bold ${
          status === "livre" ? "text-success" : "text-danger"
        }`;

        if (status === "ocupado" && posto.inicio_atendimento) {
          infoSessao.style.display = "block";
          terapeutaSpan.textContent = posto.terapeuta || "Desconhecido";
          clienteSpan.textContent = posto.cliente || "Walk-in";

          // Timer
          const inicio = new Date(posto.inicio_atendimento);
          const timerId = setInterval(() => {
            const diff = Math.floor((new Date() - inicio) / 1000);
            const min = String(Math.floor(diff / 60)).padStart(2, "0");
            const seg = String(diff % 60).padStart(2, "0");
            timer.textContent = `${min}:${seg}`;
          }, 1000);
          intervalos[posto.id] = timerId;

          btnIniciar.disabled = true;
          btnFinalizar.disabled = false;
        } else {
          timer.textContent = "00:00";
          btnIniciar.disabled = false;
          btnFinalizar.disabled = true;
        }

        // Ações (futuro: implementar POST /atendimentos/iniciar e /finalizar)
        btnIniciar.onclick = async () => {
          const nomeCliente = prompt(
            "Nome do cliente (walk-in):",
            "Cliente Avulso"
          );
          if (!nomeCliente) return;

          const res = await fetch(`${API_BASE}/controle/iniciar`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              posto_id: posto.id,
              cliente_nome: nomeCliente,
            }),
          });

          const data = await res.json();
          if (data.sucesso) {
            alert("Sessão iniciada!");
            carregarPostos(); // atualiza tudo
          } else {
            alert(data.erro || "Erro ao iniciar");
          }
        };
        btnFinalizar.onclick = async () => {
          if (!confirm("Finalizar esta sessão?")) return;

          const res = await fetch(`${API_BASE}/controle/finalizar`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ posto_id: posto.id }),
          });

          const data = await res.json();
          if (data.sucesso) {
            alert("Sessão finalizada!");
            carregarPostos();
          } else {
            alert(data.erro);
          }
        };
        btnManutencao.onclick = async () => {
          const ativar = posto.em_manutencao !== "S";
          const res = await fetch(`${API_BASE}/controle/manutencao`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ posto_id: posto.id, ativar }),
          });

          const data = await res.json();
          if (data.sucesso) {
            carregarPostos();
          }
        };

        container.appendChild(template);
      }

      function logout() {
        localStorage.clear();
        window.location.href = "login.html";
      }
    </script>
  </body>
</html>
